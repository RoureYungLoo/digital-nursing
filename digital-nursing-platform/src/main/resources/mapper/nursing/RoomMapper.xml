<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.luruoyang.nursing.mapper.RoomMapper">

    <resultMap type="Room" id="RoomResult">
        <result property="id" column="id"/>
        <result property="code" column="code"/>
        <result property="sort" column="sort"/>
        <result property="typeName" column="type_name"/>
        <result property="floorId" column="floor_id"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createBy" column="create_by"/>
        <result property="updateBy" column="update_by"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <sql id="selectRoomVo">
        select id,
               code,
               sort,
               type_name,
               floor_id,
               create_time,
               update_time,
               is_deleted,
               create_by,
               update_by,
               remark
        from room
    </sql>

    <select id="selectRoomList" parameterType="Room" resultMap="RoomResult">
        <include refid="selectRoomVo"/>
        <where>
            <if test="code != null  and code != ''">and code = #{code}</if>
            <if test="sort != null ">and sort = #{sort}</if>
            <if test="typeName != null  and typeName != ''">and type_name like concat('%', #{typeName}, '%')</if>
            <if test="floorId != null ">and floor_id = #{floorId}</if>
            <if test="isDeleted != null ">and is_deleted = #{isDeleted}</if>
        </where>
    </select>

    <select id="selectRoomById" parameterType="Long" resultMap="RoomResult">
        <include refid="selectRoomVo"/>
        where id = #{id}
    </select>


    <resultMap id="roomVoResultMap" type="com.luruoyang.nursing.entity.vo.RoomVo">
        <id property="id" column="id"/>
        <result property="code" column="code"/>
        <result property="floorId" column="floor_id"/>
        <result property="floorName" column="fname"/>
        <result column="price" property="price"/>
        <collection property="bedVoList" ofType="com.luruoyang.nursing.entity.vo.BedVo">
            <id column="bid" property="id"/>
            <result column="bed_number" property="bedNumber"/>
            <result column="bed_status" property="bedStatus"/>
            <result column="room_id" property="roomId"/>
            <result column="ename" property="ename"/>
            <result column="eid" property="elderId"/>
        </collection>
    </resultMap>

    <select id="selectByFloorId" resultMap="roomVoResultMap">
        select r.*,
               f.name as fname,
               rt.*,
               b.id   as bid,
               b.bed_number,
               b.sort,
               b.bed_status,
               b.room_id,
               b.create_by,
               b.update_by,
               b.remark,
               b.create_time,
               b.update_time,
               e.name as ename,
               e.id   as eid
        from room r
                 left join floor f on f.id = r.floor_id
                 left join room_type rt on rt.name = r.type_name
                 left join bed b on b.room_id = r.id
                 left join elder e on b.id = e.bed_id
        where r.floor_id = #{floorId}
        order by r.sort, r.create_time desc
    </select>


    <resultMap id="roomVoWithNurResultMap" type="com.luruoyang.nursing.entity.vo.RoomVo">
        <id property="id" column="id"/>
        <result property="code" column="code"/>
        <result property="floorId" column="floor_id"/>
        <result property="floorName" column="fname"/>
        <result column="price" property="price"/>
        <collection property="bedVoList" ofType="com.luruoyang.nursing.entity.vo.BedVo">
            <id column="bid" property="id"/>
            <result column="bed_number" property="bedNumber"/>
            <result column="bed_status" property="bedStatus"/>
            <result column="room_id" property="roomId"/>
            <result column="ename" property="ename"/>
            <result column="eid" property="elderId"/>
            <collection property="userVos" ofType="com.luruoyang.common.core.domain.entity.SysUser" column="eid"
                        select="com.luruoyang.nursing.mapper.NursingElderMapper.selectUserByElderId">
                <result column="nick_name" property="nickName"/>
                <result column="userId" property="userId"/>
            </collection>
        </collection>
    </resultMap>

    <select id="selectByFloorIdWithNur" resultMap="roomVoWithNurResultMap">
        select r.*,
               b.id   as bid,
               b.bed_number,
               b.sort,
               b.bed_status,
               b.room_id,
               e.name as ename,
               e.id   as eid
        from room r
                 left join bed b on b.room_id = r.id
                 left join elder e on e.bed_id = b.id
        where r.floor_id = #{floorId}
          and e.id is not null
        order by r.sort, r.create_time desc
    </select>

    <resultMap id="frdiMap" type="com.luruoyang.nursing.entity.vo.RoomVo">
        <id property="id" column="rid"/>
        <result property="floorId" column="r_floor_id"/>
        <result property="code" column="rcode"/>
        <collection property="bedVoList" ofType="com.luruoyang.nursing.entity.vo.BedVo">
            <id property="id" column="bid"/>
            <result property="bedNumber" column="bed_number"/>
            <result property="bedStatus" column="bed_status"/>
            <result property="roomId" column="room_id"/>
            <result property="ename" column="ename"/>
            <result property="elderId" column="eid"/>
            <collection property="deviceVos" ofType="com.luruoyang.nursing.entity.vo.DeviceInfo">
                <id property="id" column="bd_id"/>
                <result property="iotId" column="bd_iot_id"/>
                <result property="deviceName" column="bd_device_name"/>
                <result property="productKey" column="bd_product_key"/>
                <result property="productName" column="bd_product_name"/>
            </collection>
        </collection>
        <collection property="deviceVos" ofType="com.luruoyang.nursing.entity.vo.DeviceInfo">
            <id property="id" column="rd_id"/>
            <result property="iotId" column="rd_iot_id"/>
            <result property="deviceName" column="rd_device_name"/>
            <result property="productKey" column="rd_product_key"/>
            <result property="productName" column="rd_product_name"/>
        </collection>
    </resultMap>
    <select id="getRoomsWithDeviceByFloorId" resultMap="frdiMap">
        select r.id            rid,
               r.code          rcode,
               r.floor_id      r_floor_id,
               b.id            bid,
               b.bed_number,
               b.bed_status,
               b.room_id,
               e.name          ename,
               e.id            eid,
               -- 房间设备数据
               rd.id           rd_id,
               rd.iot_id       rd_iot_id,
               rd.device_name  rd_device_name,
               rd.product_key  rd_product_key,
               rd.product_name rd_product_name,
               -- 床位设备数据
               bd.id           bd_id,
               bd.iot_id       bd_iot_id,
               bd.device_name  bd_device_name,
               bd.product_key  bd_product_key,
               bd.product_name bd_product_name

        from room r
                 left join bed b on b.room_id = r.id
                 left join elder e on e.bed_id = b.id
            -- room device
                 left join device rd
                           on rd.binding_location = r.id and rd.location_type = 1 and rd.physical_location_type = 1
            -- bed device
                 left join device bd
                           on bd.binding_location = b.id and bd.location_type = 1 and bd.physical_location_type = 2
        where floor_id = #{floorId}
          and (bd.id is not null or rd.id is not null)
    </select>

    <insert id="insertRoom" parameterType="Room" useGeneratedKeys="true" keyProperty="id">
        insert into room
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="code != null">code,</if>
            <if test="sort != null">sort,</if>
            <if test="typeName != null">type_name,</if>
            <if test="floorId != null">floor_id,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="isDeleted != null">is_deleted,</if>
            <if test="createBy != null">create_by,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="remark != null">remark,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="code != null">#{code},</if>
            <if test="sort != null">#{sort},</if>
            <if test="typeName != null">#{typeName},</if>
            <if test="floorId != null">#{floorId},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="isDeleted != null">#{isDeleted},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="remark != null">#{remark},</if>
        </trim>
    </insert>

    <update id="updateRoom" parameterType="Room">
        update room
        <trim prefix="SET" suffixOverrides=",">
            <if test="code != null">code = #{code},</if>
            <if test="sort != null">sort = #{sort},</if>
            <if test="typeName != null">type_name = #{typeName},</if>
            <if test="floorId != null">floor_id = #{floorId},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="isDeleted != null">is_deleted = #{isDeleted},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteRoomById" parameterType="Long">
        delete
        from room
        where id = #{id}
    </delete>

    <delete id="deleteRoomByIds" parameterType="String">
        delete from room where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="getRoomFloorPriceById" resultType="com.luruoyang.nursing.entity.vo.RoomVo"
            parameterType="java.lang.Long">
        select f.name floorName, f.id floorId, r.id roomId, r.code, rt.price
        from room r
                 left join room_type rt on r.type_name = rt.name
                 left join floor f on r.floor_id = f.id
        where r.id = #{roomId}
    </select>
</mapper>